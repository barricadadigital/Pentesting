# 445 - SMB

Si nos encontramos frente a un puerto 445 abierto probablemente tenemos enfrente un servidor samba. Es una serie de herramientas que se utilizan para administrar el protocolo SMB y generalmente para compartir recursos. También puede actuar como un controlador de dominio en Windows.

¿Qué podemos hacer para encontrar vulnerabilidades?

## Enumeración de vulnerabilidades con nmap

Existen una serie de scripts en Samba que nos permiten encontrar ciertas vulnerabilidades para enfrentarse ante un servidor samba.

```
nmap -p445 10.10.10.55 --script="smb-vuln*"
```

¡Ojo con los falsos positivos!

## Null session

También podemos comprobar si tenemos acceso a ciertos recursos a través de un NULL SESSION, esto es una sesión anónima que nos puede permitir ver ciertos recursos de la máquina a la que estamos intentando acceder o recursos compartidos con esta en la red.

```
smbclient -N -L //10.10.10.55/
smbclient -N //10.10.10.27/recursoabierto

crackmapexec smb 10.10.10.55 --shares 2>/dev/null

smbmap -H 10.10.10.55
smbmap -H 10.10.10.55 -u 'null'
```

## Usuario sin contraseña

Podemos probar si algún usuario por defecto no tiene contraseña (admin, administrator, root)

```
smbclient -L //10.10.10.55/recursoabierto -U "admin"
```

## Hash del usuario

Si tenemos el Hash de un usuario con acceso al recurso compartido:

```
pth-smbclient //<IP>/<recurso> -U <usuario>%<hash>
```

## Información SO

Podemos obtener cierta información sobre el SO y algún dato más gracias a CrackMapExec, una herramienta que además nos permite saber si el servidor SMB está o no firmado.

```
crackmapexec smb 10.10.10.55
```

## Búsqueda recursiva

Podemos utilizar smbmap para realizar una búsqueda rápida recursiva e incluso seleccionar el archivo que queremos descargar.

```
smbmap -d DOMINIO -H 10.10.10.55 -R SYSVOL
smbmap -d DOMINIO -H 10.10.10.55 -R SYSVOL -A Groups.xml -q
```

## Listar permisos

```
smbcacls //10.10.10.55/Carpeta DOMINIO/directorio -U 'USUARIO%CONTRASEÑA' |grep -i everyone
```

## Dump de información del sistema

Puedes verlo en [post-explotación](../../post-explotacion/informacion-extra/windows.md#crackmapexec), aunque en ocasiones podemos obtener dicha información antes por ejemplo con el Hash NTLM de algún usuario con altos privilegios.

## PSExec

Podemos conectarnos teniendo credenciales válidas (o hashes) a través de PSExec que nos genera una conexión utilizando el servicio SAMBA

```
#Ejemplo de uso
impacket-psexec <dominio>/<usuario>@<IP> -hashes <hash> -p <contraseña>
```

## Practicar

* [Archetype (HTB)](../../../HTB/htb/archetype.md)
* Máquina "[Dancing](../../../HTB/htb/dancing.md)" HTB \[Acceso 16/10/2021]
* Máquina "[Tactics](../../../HTB/htb/tactics.md)" HTB \[Acceso 10/12/2021]
* Máquina "[Lame](https://www.youtube.com/watch?v=gOmFNR2-VFw)" HTB \[Acceso 01/02/2022]



> \*Disclaimer: Este manual está realizado en base a lo que voy aprendiendo, si parte de la información que comparto no es correcta estaré encantado de que te pongas en contacto conmigo para hacérmelo saber y poder modificarlo.
