---
description: >-
  Es la técnica por la que vamos a poder acceder a recursos fuera de la primera
  red en la que estamos
---

# Port Forwarding / Pivoting

Las técnicas de pivoting son importantes ya que en ocasiones podemos entrar en redes que tienen algún tipo de segmentación. Por esa razón desde la primera red no vamos a poder acceder a las demás pero existen diversos métodos para poder realizar ese pivoting.

### Tabla de enrutamiento

Los protocolos de enrutamiento son usado para determinar el mejor camino para alcanzar una red. Hay que tener en cuenta que no solo el router guarda esta tabla sino que cada host también lo hace.

```
route            

Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.1.2     0.0.0.0         UG    0      0        0 eth0
10.175.34.0     *               255.255.255.0   U     0      0        0 tap0
172.16.88.0     10.175.34.1     255.255.255.0   UG    0      0        0 tap0
192.168.1.0     *               255.255.255.0   U     0      0        0 eth0
192.168.241.0   10.175.34.1     255.255.255.0   UG    0      0        0 tap0
```

En este caso concreto tenemos eth0 que es la conexión por cable y tap0 que es de una VPN.

Nosotros podríamos añadir nuevos valores a esta tabla, ¿Cuándo hacerlo? Cuando hayamos obtenido información de otra posible red que queramos alcanzar. Pongamos como ejemplo que sabemos que a través de 192.168.222.0/24 podemos acceder a un servidor situado en 192.168.222.199

```
ip route add 192.168.222.0/24 via 10.175.34.1
```

Estamos añadiendo una ruta desde nuestra gateway hasta esa red.

## Chisel

Chisel es una herramienta que me encanta y nos permite hacer pivoting a través de las redes, es muy sencilla de utilizar y lo suficientemente potente para hacer lo que necesitemos.

{% embed url="https://github.com/jpillora/chisel/releases/latest" %}

Podemos descargar las releases o podemos compilarlas nosotros mismos, las instrucciones vienen en el github.

### Servidor

En nuestra máquina atacante pondremos el servidor, es importante que lo hagamos con el argumento --reverse ya que nos permitirá que podamos lanzar conexiones desde nuestra máquina a la máquina objetivo para llegar a un tercero.

```
chisel server –reverse -p <puerto>
```

### Cliente

En el cliente tenemos que marcar los puertos que vamos a enlazar, si queremos que la petición salga de nuestra máquina para llegar al puerto de otra máquina utilizaremos el argumento R

```
chisel client <IPservidor>:<puertoservidor> R:<iplocal>:<puertolocal>:<ipdestino>:<puertodestino>

#Ejemplo para enlazar nuestro puerto 77 con el puerto remoto 77
chisel client 10.10.10.10:9999 R:127.0.0.1:77:192.168.10.15:77
```

Por otro lado quizás lo que queremos, por ejemplo para establecer una reverse shell, es que la información que llega desde el Host externo se tunelice hasta nuestra máquina.

```
chisel client <IPservidor>:<puertoservidor> <ipreceptora>:<puertoreceptor>:<ipatacante>:<puertoatacante>

#Ejemplo para que todo lo que llegue al cliente por el puerto 4545 lo capture nuestra máquina atacante en el puerto 5555
chisel client 10.10.10.10:9999 0.0.0.0:4545:10.10.10.10:5555
```

### SOCKS

En ocasiones queremos enlazar absolutamente todo, de tal manera que la máquina intermedia la utilicemos cómo proxy de todas las peticiones. Para ello utilizamos socks y proxychains.

Primer nos aseguramos de que en "/etc/proxychains.conf" tengamos configurado correctamente cómo en la imagen socks5 (podemos cambiar el puerto si queremos).

![](<../../.gitbook/assets/image (37).png>)

Ahora en el servidor tenemos que especificar que queremos utilizar socks.

```
./chisel server -p <puerto> --socks5 --reverse
```

Y por otro lado en el cliente establecemos la conexión por socks.

```
./chisel client <IPservidor>:<Puertoservidor> R:<puertosocks>:socks

#Ejemplo
./chisel client 10.10.10.10:9999 R:1080:socks
```

De esta manera si por ejemplo lanzamos un nmap a través de proxychains podremos analizar todos los puertos utilizando la máquina del cliente cómo proxy de las peticiones.

```
proxychains -q nmap -p- --open -n -Pn <IPobjetivo>

#Ejemplo
proxychains -q nmap -p- --open -n -Pn 192.168.10.15
```

## Practicar

* Máquina "BankRobber" de HTB \[Acceso 03/02/2022]

> \*Disclaimer: Este manual está realizado en base a lo que voy aprendiendo, si parte de la información que comparto no es correcta estaré encantado de que te pongas en contacto conmigo para hacérmelo saber y poder modificarlo.
